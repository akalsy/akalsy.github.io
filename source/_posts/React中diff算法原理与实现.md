---
title: React中diff算法原理与实现
date: 2024-11-18 16:18:28
tags:
---
React 中的 **Diff 算法** 是其虚拟 DOM 的核心，用于高效地比较新旧虚拟 DOM 树，并生成最小的更新操作集合以更新实际 DOM。由于 DOM 操作通常是性能瓶颈，React 的 Diff 算法基于一系列假设和优化策略，实现了近似的最优性能。

---

## **1. Diff 算法的基本原则**
React 的 Diff 算法并非传统意义上的 O(n³) 完全对比，而是基于以下三条核心策略进行了优化：
1. **树的分层比较**  
   - React 假设两个组件的层级结构相同，子节点的比较只会在同一层进行，不会跨层级比较。
   - 如果某一层的根节点类型不同，直接删除旧节点并创建新节点，忽略其子树。

2. **同级节点的 key 优化**  
   - React 使用 `key` 来识别同级的子节点是否为相同元素。
   - 若 key 不同，React 会认为它们是不同的节点，并重新创建。

3. **组件的类型优先级**  
   - 对于类组件或函数组件，如果类型相同，则复用组件实例并更新其 props。
   - 如果类型不同，直接卸载旧组件并重新创建新组件。

---

## **2. Diff 算法的三大过程**
React 的 Diff 算法主要分为以下三个过程：

### **2.1 节点树的比较**
- **相同类型节点**：更新属性。
  ```jsx
  <div id="old" /> => <div id="new" />
  ```
  - React 比较 `div` 的类型相同，只更新属性 `id`。

- **不同类型节点**：直接替换整个节点。
  ```jsx
  <div /> => <span />
  ```
  - React 会移除旧的 `div` 节点，并新建 `span` 节点。

---

### **2.2 子节点的比较**
子节点的比较是 React Diff 算法的重点，具体策略如下：

#### **2.2.1 简单情况**
如果子节点是一个列表且没有 `key`，React 会按照索引逐个比较。
```jsx
<ul>
  <li>One</li>
  <li>Two</li>
</ul>
```
当更新为：
```jsx
<ul>
  <li>One</li>
  <li>Three</li>
</ul>
```
React 会直接复用第一个 `li`，并更新第二个 `li`。

#### **2.2.2 使用 `key` 优化比较**
如果子节点带有 `key` 属性，React 会根据 `key` 进行匹配，而不是简单地按顺序比较。

示例：
```jsx
<ul>
  <li key="a">One</li>
  <li key="b">Two</li>
</ul>
```
更新为：
```jsx
<ul>
  <li key="b">Two</li>
  <li key="a">One</li>
</ul>
```
- React 会通过 `key` 发现节点位置交换。
- 而不是删除和重新创建这两个节点。

这种 `key` 优化可以显著提高列表动态更新时的性能。

---

### **2.3 组件的比较**
- **相同类型的组件**：保留组件实例，更新 `props`。
  ```jsx
  <ComponentA prop="old" /> => <ComponentA prop="new" />
  ```
  React 会调用 `ComponentA` 的生命周期方法（如 `shouldComponentUpdate` 或 `useEffect`），只更新其属性。

- **不同类型的组件**：卸载旧组件，创建新组件。
  ```jsx
  <ComponentA /> => <ComponentB />
  ```
  React 会销毁 `ComponentA` 的实例，并重新渲染 `ComponentB`。

---

## **3. Diff 算法的实现细节**

### **3.1 整体流程**
React 的虚拟 DOM 树由 Fiber 数据结构表示，Diff 过程基于 Fiber 节点进行递归：
1. **比较节点类型**：
   - 类型相同：更新属性。
   - 类型不同：替换整个节点。
2. **比较子节点**：
   - 通过 `key` 确定是否需要移动或复用节点。
   - 遍历列表的新增、删除或更新操作。
3. **生成更新队列**：
   - 记录需要执行的操作，最终批量更新真实 DOM。

---

### **3.2 `key` 的作用**
React 通过 `key` 来跟踪子节点的身份，解决以下问题：
- 当节点顺序发生变化时，避免不必要的移除和重新创建。
- 提高列表渲染的性能。

**无 `key` 的情况**：
```jsx
<ul>
  <li>One</li>
  <li>Two</li>
</ul>
```
变更为：
```jsx
<ul>
  <li>Three</li>
  <li>One</li>
</ul>
```
React 会重新创建所有节点。

**有 `key` 的情况**：
```jsx
<ul>
  <li key="1">One</li>
  <li key="2">Two</li>
</ul>
```
变更为：
```jsx
<ul>
  <li key="2">Two</li>
  <li key="1">One</li>
</ul>
```
React 会通过 `key` 检测顺序变化，只更新位置。

---

## **4. Diff 算法的复杂度**
React 的 Diff 算法通过以下方式优化复杂度：
- **树分层比较**：将复杂度从 O(n³) 降低到 O(n)。
- **`key` 优化**：减少列表中的重新渲染。

具体复杂度分析：
- **节点类型比较**：O(1)。
- **属性比较**：O(n)，其中 n 是属性数量。
- **子节点比较**：
  - 无 `key` 时：O(n)。
  - 有 `key` 时：O(n) + O(m)，其中 m 是 `key` 查找的哈希表操作复杂度。

---

## **5. Diff 的限制与优化建议**

### **5.1 限制**
- **跨层级移动**：React 不会优化跨层级的节点移动，因为假设节点层级不会变化。
- **缺乏唯一 `key`**：若没有提供稳定的 `key`，性能可能下降，甚至导致渲染错误。

### **5.2 优化建议**
1. **使用稳定的 `key`**：
   - 避免使用索引作为 `key`。
   - 提供唯一标识，如数据库的 `id`。
2. **减少 DOM 层级的无关变化**：
   - 避免频繁改变节点的层级结构。
3. **分离独立部分**：
   - 将不相关的 UI 拆分成独立组件，减少 Diff 范围。

---

## **总结**
React 的 Diff 算法基于简化规则和分层比较策略，实现了高效的虚拟 DOM 更新。通过使用 `key` 优化列表比较和组件类型判断，React 能够在绝大多数场景中保持出色的性能。但在特定场景下，开发者仍需通过优化 `key` 和组件设计来提高性能。